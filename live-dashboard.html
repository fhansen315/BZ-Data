<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BZ-Data Live Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .metric-change {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .alert-item {
            border-left: 4px solid;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0 8px 8px 0;
        }
        .alert-high { border-left-color: #dc3545; background-color: #f8d7da; }
        .alert-medium { border-left-color: #ffc107; background-color: #fff3cd; }
        .alert-low { border-left-color: #17a2b8; background-color: #d1ecf1; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-bullish { background-color: #28a745; }
        .status-neutral { background-color: #ffc107; }
        .status-bearish { background-color: #dc3545; }
        .chart-container { height: 300px; margin-bottom: 1rem; }
        .live-indicator {
            animation: pulse 2s infinite;
            color: #28a745;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .last-update {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="bi bi-graph-up live-indicator"></i>
                BZ-Data Live Dashboard
            </span>
            <span class="navbar-text">
                <i class="bi bi-clock"></i>
                <span id="last-update" class="last-update">Loading...</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="total-volume">$0</div>
                    <div>Total Volume</div>
                    <div class="metric-change" id="volume-change">+0.0%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="active-institutions">0</div>
                    <div>Active Institutions</div>
                    <div class="metric-change">Real-time</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="market-sentiment">Loading...</div>
                    <div>Market Sentiment</div>
                    <div class="metric-change" id="sentiment-indicator">
                        <span class="status-indicator status-neutral"></span>
                        <span id="sentiment-text">Analyzing...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="risk-level">Low</div>
                    <div>Risk Level</div>
                    <div class="metric-change" id="risk-score">Score: 0.0</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Real-time Volume Trends</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="updateChart('volume')">Volume</button>
                            <button type="button" class="btn btn-outline-primary" onclick="updateChart('volatility')">Volatility</button>
                            <button type="button" class="btn btn-outline-primary" onclick="updateChart('returns')">Returns</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="main-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Live Alerts</h5>
                    </div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <div id="alerts-container">
                            <div class="text-center text-muted">
                                <i class="bi bi-shield-check"></i>
                                <p>No alerts at this time</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Institution Performance</h5>
                    </div>
                    <div class="card-body">
                        <div id="institution-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Modality Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="modality-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Row -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Live Data Feed</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData()">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Institution</th>
                                        <th>Modality</th>
                                        <th>Value</th>
                                        <th>Change</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentData = [];
        let currentChart = 'volume';
        let updateInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startRealTimeUpdates();
        });

        function initializeDashboard() {
            loadInitialData();
            createCharts();
        }

        function loadInitialData() {
            // Simulate loading initial data
            const sampleData = generateSampleData();
            updateDashboard(sampleData);
        }

        function generateSampleData() {
            const institutions = ['Bank_Alpha', 'Bank_Beta', 'Bank_Gamma'];
            const modalities = ['Spot', 'Forward', 'Swap', 'Options'];
            const data = [];
            
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getTime() - (11 - i) * 30 * 24 * 60 * 60 * 1000);
                
                institutions.forEach(inst => {
                    modalities.forEach(mod => {
                        const baseValue = {
                            'Spot': 150000,
                            'Forward': 100000,
                            'Swap': 180000,
                            'Options': 50000
                        }[mod];
                        
                        const instMultiplier = {
                            'Bank_Alpha': 1.0,
                            'Bank_Beta': 0.8,
                            'Bank_Gamma': 1.2
                        }[inst];
                        
                        const trend = 1 + (i * 0.02); // 2% monthly growth
                        const noise = 0.9 + Math.random() * 0.2; // ±10% noise
                        
                        data.push({
                            date: date.toISOString().split('T')[0],
                            institution: inst,
                            modality: mod,
                            value: Math.round(baseValue * instMultiplier * trend * noise),
                            change: (Math.random() - 0.5) * 0.1, // ±5% change
                            isNew: i === 11 // Mark latest as new
                        });
                    });
                });
            }
            
            return data;
        }

        function updateDashboard(data) {
            currentData = data;
            updateMetrics(data);
            updateCharts(data);
            updateAlerts(data);
            updateDataTable(data);
            updateLastUpdateTime();
        }

        function updateMetrics(data) {
            const latest = data.filter(d => d.isNew);
            const totalVolume = latest.reduce((sum, d) => sum + d.value, 0);
            const avgChange = latest.reduce((sum, d) => sum + d.change, 0) / latest.length;
            
            document.getElementById('total-volume').textContent = '$' + (totalVolume / 1000000).toFixed(1) + 'M';
            document.getElementById('volume-change').textContent = (avgChange >= 0 ? '+' : '') + (avgChange * 100).toFixed(1) + '%';
            document.getElementById('active-institutions').textContent = new Set(latest.map(d => d.institution)).size;
            
            // Market sentiment
            const sentiment = avgChange > 0.02 ? 'Bullish' : avgChange < -0.02 ? 'Bearish' : 'Neutral';
            document.getElementById('market-sentiment').textContent = sentiment;
            
            const indicator = document.querySelector('#sentiment-indicator .status-indicator');
            indicator.className = 'status-indicator status-' + sentiment.toLowerCase();
            document.getElementById('sentiment-text').textContent = sentiment;
            
            // Risk level
            const volatility = Math.abs(avgChange);
            const riskLevel = volatility > 0.05 ? 'High' : volatility > 0.02 ? 'Medium' : 'Low';
            document.getElementById('risk-level').textContent = riskLevel;
            document.getElementById('risk-score').textContent = 'Score: ' + (volatility * 20).toFixed(1);
        }

        function updateCharts(data) {
            updateMainChart(data);
            updateInstitutionChart(data);
            updateModalityChart(data);
        }

        function updateMainChart(data) {
            const chartData = prepareChartData(data, currentChart);
            
            Plotly.newPlot('main-chart', chartData.traces, chartData.layout, {responsive: true});
        }

        function prepareChartData(data, type) {
            if (type === 'volume') {
                const groupedData = d3.group(data, d => d.date);
                const dates = Array.from(groupedData.keys()).sort();
                const values = dates.map(date => 
                    Array.from(groupedData.get(date)).reduce((sum, d) => sum + d.value, 0)
                );
                
                return {
                    traces: [{
                        x: dates,
                        y: values,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: {color: '#0066CC', width: 3},
                        marker: {size: 8},
                        name: 'Total Volume'
                    }],
                    layout: {
                        title: 'Volume Trends',
                        xaxis: {title: 'Date'},
                        yaxis: {title: 'Volume ($)', tickformat: '$,.0f'},
                        margin: {t: 40, r: 20, b: 40, l: 60}
                    }
                };
            }
            // Add other chart types as needed
            return {traces: [], layout: {}};
        }

        function updateInstitutionChart(data) {
            const latest = data.filter(d => d.isNew);
            const instData = d3.rollup(latest, v => d3.sum(v, d => d.value), d => d.institution);
            
            const trace = {
                x: Array.from(instData.keys()),
                y: Array.from(instData.values()),
                type: 'bar',
                marker: {color: '#28a745'}
            };
            
            Plotly.newPlot('institution-chart', [trace], {
                title: 'Current Volume by Institution',
                yaxis: {tickformat: '$,.0f'},
                margin: {t: 40, r: 20, b: 40, l: 60}
            }, {responsive: true});
        }

        function updateModalityChart(data) {
            const latest = data.filter(d => d.isNew);
            const modData = d3.rollup(latest, v => d3.sum(v, d => d.value), d => d.modality);
            
            const trace = {
                labels: Array.from(modData.keys()),
                values: Array.from(modData.values()),
                type: 'pie',
                textinfo: 'label+percent',
                marker: {
                    colors: ['#0066CC', '#28a745', '#ffc107', '#dc3545']
                }
            };
            
            Plotly.newPlot('modality-chart', [trace], {
                title: 'Volume Distribution by Modality',
                margin: {t: 40, r: 20, b: 20, l: 20}
            }, {responsive: true});
        }

        function updateAlerts(data) {
            const alerts = generateAlerts(data);
            const container = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-shield-check"></i>
                        <p>No alerts at this time</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.severity}">
                    <strong>${alert.type}</strong><br>
                    ${alert.message}
                    <small class="d-block text-muted mt-1">${alert.time}</small>
                </div>
            `).join('');
        }

        function generateAlerts(data) {
            const alerts = [];
            const latest = data.filter(d => d.isNew);
            
            // High change alerts
            latest.forEach(d => {
                if (Math.abs(d.change) > 0.05) {
                    alerts.push({
                        type: 'Volume Alert',
                        message: `${d.institution} ${d.modality}: ${d.change > 0 ? '↑' : '↓'} ${Math.abs(d.change * 100).toFixed(1)}%`,
                        severity: Math.abs(d.change) > 0.1 ? 'high' : 'medium',
                        time: new Date().toLocaleTimeString()
                    });
                }
            });
            
            return alerts.slice(0, 5); // Show only latest 5 alerts
        }

        function updateDataTable(data) {
            const tbody = document.getElementById('data-table-body');
            const latest = data.filter(d => d.isNew).slice(0, 10);
            
            tbody.innerHTML = latest.map(d => `
                <tr ${d.isNew ? 'class="table-success"' : ''}>
                    <td>${d.date}</td>
                    <td>${d.institution}</td>
                    <td>${d.modality}</td>
                    <td>$${d.value.toLocaleString()}</td>
                    <td class="${d.change >= 0 ? 'text-success' : 'text-danger'}">
                        ${d.change >= 0 ? '+' : ''}${(d.change * 100).toFixed(2)}%
                    </td>
                    <td>
                        <span class="badge bg-${d.isNew ? 'success' : 'secondary'}">
                            ${d.isNew ? 'New' : 'Historical'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateLastUpdateTime() {
            document.getElementById('last-update').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        }

        function updateChart(type) {
            currentChart = type;
            
            // Update button states
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateMainChart(currentData);
        }

        function startRealTimeUpdates() {
            updateInterval = setInterval(() => {
                // Simulate new data
                const newData = generateSampleData();
                updateDashboard(newData);
            }, 30000); // Update every 30 seconds
        }

        function exportData() {
            const csv = convertToCSV(currentData.filter(d => d.isNew));
            downloadCSV(csv, 'bz-data-export.csv');
        }

        function convertToCSV(data) {
            const headers = ['Date', 'Institution', 'Modality', 'Value', 'Change'];
            const rows = data.map(d => [d.date, d.institution, d.modality, d.value, d.change]);
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
